<!DOCTYPE html><html lang="zh-CN,en,default"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A legendary army."><title>Practical Encoding in Python2 | Crusade</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Practical Encoding in Python2</h1><a id="logo" href="/.">Crusade</a><p class="description">For honor!</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Practical Encoding in Python2</h1><div class="post-meta">Nov 29, 2017<span> | </span><span class="category"><a href="/categories/Language/">Language</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/11/29/python2-unicode/" href="/2017/11/29/python2-unicode/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>We all know how a python script gets run. The python interpreter reads the source file, trans-compiles it into machine code and runs it. Mainly we write codes in ASCII, but what if we need a string containing unicode characters like: <code>s = “你好哇”</code>? The default encoding of source code is ASCII, and python interpreter will throw an error since it doesn’t know how to parse it. Therefore, the magic comment <code># coding=utf-8</code> shows at the first line. It tells the interpreter that the source code is encoded in UTF-8, and please parse it in this encoding. <a href="https://www.python.org/dev/peps/pep-0263/" target="_blank" rel="external">PEP</a> explains it very well, and magic comment like <code># -*- coding: utf-8 -*-</code> also works. </p>
<p>You may be full of questions now, e.g. what is encoding? What is unicode and UTF-8？It’s a long story, and for encoding, it is a way in which a computer understands the bytes in the memory, please read this <a href="https://www.w3.org/International/questions/qa-what-is-encoding" target="_blank" rel="external">post</a> to learn more. For UTF-8 and unicode, I just want make it clear that <a href="https://en.wikipedia.org/wiki/unicode" target="_blank" rel="external">unicode</a> is an encoding standard and <a href="https://en.wikipedia.org/wiki/UTF-8" target="_blank" rel="external">UTF-8</a> is just an encoding format of unicode. There are some other encodings, including <a href="https://en.wikipedia.org/wiki/GBK" target="_blank" rel="external">GBK</a>, which is widely used on Windows platform. Python programmers in China would always get mad dealing with the encoding on different platform, and this post will discuss some practical topics about that.</p>
<h2 id="Output-to-the-terminal"><a href="#Output-to-the-terminal" class="headerlink" title="Output to the terminal"></a>Output to the terminal</h2><p>First, let’s introduce encodings on different places:</p>
<ol>
<li><strong>Source code encoding</strong>: as we have discussed, can be specified with “# coding=utf-8”</li>
<li><strong>File system encoding</strong>: that’s how a text file gets encoded in the file system.</li>
<li><strong>Terminal encoding</strong>: it’s used in command line tools or terminals like iTerm, Terminal apps.</li>
</ol>
<p>So, what’s the output of the following code snippet?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s = “你好哇”</div><div class="line"><span class="keyword">print</span> s</div></pre></td></tr></table></figure>
<p>It depends. First, to make it understandable to  the interpreter, a magic comment needs to be added, e.g., <code># coding=utf-8</code>, then on Mac platform, it will work as expected and output <code>你好哇</code>. But on the Windows platform, the terminal will print gibberish like “浣犲ソ鍝” when the system encoding is GBK. That’s because with GBK the interpreter cannot successfully decode what’s encoded with UTF-8. So, how to make it correct? You may try to change <code># coding=utf-8</code> to <code># coding=gbk</code>, and hope it will work.  However, the following error could make you totally lost:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SyntaxError: &apos;gbk&apos; codec can&apos;t decode bytes in position 13-14:</div><div class="line">    illegal multibyte sequence</div></pre></td></tr></table></figure>
<p>Emm… what’s that all about? Here is another encoding concept: source file encoding. Depending on your text editor, the source file encoding may be UTF-8, ANSI,  etc. Here’s the story, you tell the interpreter that the source file is encoded in GBK with <code># coding=gbk</code>, but actually the interpreter gets a source file encoded in UTF-8, and it can’t parse some characters e.g., “你好哇”, successfully. One solution is, with your favorite editor, save it in GBK encoding and using magic comment “# coding=gbk”. Make sure the encoding specified with magic comment be the same with the source file encoding.</p>
<p>There is another solution to this problem. Change the magic comment to <code># coding=utf-8</code> and make sure the file encoding is also UTF-8. We could first get the unicode string of “你好哇” by <code>u = s.decode(&quot;utf-8”)</code> and then encode it again with GBK: <code>s_gbk = u.encode(“gbk”)</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># coding=utf-8</div><div class="line"></div><div class="line">s = "你好哇”</div><div class="line">u = s.decode("utf-8”)</div><div class="line">s_gbk = u.encode("gbk")</div><div class="line"></div><div class="line">print s_gbk</div></pre></td></tr></table></figure>
<p>Also, you can directly print a unicode string to the terminal. The unicode string would find the encoding, i.e., <code>sys.stdout.encoding</code>, to encode itself.</p>
<h2 id="Input-from-the-terminal"><a href="#Input-from-the-terminal" class="headerlink" title="Input from the terminal"></a>Input from the terminal</h2><p>We can use <code>sys.argv</code> to get the command arguments and <code>raw_input</code> to get the user’s input. All these are strings encoded in the <code>sys.stdout.encoding</code>, which is UTF-8 on Mac/Linux and cp936 on Windows. You can take cp936 the same thing as GBK, though GBK is an extension to that. Here is the point, you need make sure the encodings are the same if you want to perform string manipulations, e.g., concatenation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding=utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line">encoding = sys.stdout.encoding</div><div class="line"></div><div class="line">name = raw_input(<span class="string">u"你叫啥子？"</span>.encode(encoding))</div><div class="line"><span class="keyword">print</span> <span class="string">u"你好哇！"</span> + name.decode(encoding)</div></pre></td></tr></table></figure>
<p><code>name.decode(encoding)</code> will return a unicode, and we can perform concatenation between unicode strings. Here I use <code>sys.stdout.encoding</code> to make it portable across different platforms.</p>
<p>Here is another more verbose version:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding=utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">encoding = sys.stdout.encoding</div><div class="line">name = raw_input(<span class="string">u"你叫啥子？"</span>.encode(encoding))</div><div class="line">greetings = <span class="string">"你好哇！"</span> + name.decode(encoding).encode(<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> greetings.decode(<span class="string">'utf-8'</span>).encode(encoding)</div></pre></td></tr></table></figure>
<p>Here, <code>你好哇！</code> is encoded in UTF-8, and we need to make <code>name</code> encoded in UTF-8 so that the two can be concatenated together to form a UTF-8 string, and then, another trans-coding is performed to make it encoded in <code>stdout</code>’s encoding.</p>
<h2 id="File-IO"><a href="#File-IO" class="headerlink" title="File IO"></a>File IO</h2><p>File IO is similar to terminal IO, which just happens in a different place. So, the key point is the string encoding and the file encoding. The <code>read()</code> and <code>write()</code> functions are dumb, they just return a string or output a string, and it’s the programmer’s duty to decide which encoding should be used to encode/decode the string. Let’s see an example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding=utf-8</span></div><div class="line"></div><div class="line">s = <span class="string">'你好哇'</span></div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'hello.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">    f.write(s)</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'hello.txt'</span>) <span class="keyword">as</span> f:</div><div class="line">    <span class="keyword">print</span> f.read().decode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<p>String <code>s</code> is encoded in UTF-8, and we need to decode it after reading it from the file. You will get the right output if you remove <code>.decode(&#39;utf-8’)</code> on Mac/Linux platform since the default locale is UTF-8, but it will output gibberish on Windows platform since the locale there is ‘cp936’.</p>
<h2 id="A-practical-problem"><a href="#A-practical-problem" class="headerlink" title="A practical problem"></a>A practical problem</h2><p>My friend and I have crawled some English name data, one property of an English name is the International Phonetic Alphabet (IPA). For example, the IPA for name “Sean” is “ʃɔn”, and there are some non-ASCII characters in it. So, if I dump the name data directly, like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">data = &#123; <span class="string">'name'</span>: <span class="string">'sean'</span>, <span class="string">'ipa'</span>: <span class="string">'ʃɔn'</span> &#125;</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'data.json'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">    json.dump(data, f)</div></pre></td></tr></table></figure>
<p>the <code>ʃɔn</code> would get in unicode escape form:  <code>{&quot;ipa&quot;: &quot;\u0283\u0254n&quot;, &quot;name&quot;: &quot;Sean”}</code>, which is not readable for human beings. There is a parameter of <code>dump</code> called <code>ensure_ascii</code>, which defaults to <code>True</code>. As python doc puts it:</p>
<blockquote><p>If <code>ensure_ascii</code> is true (the default), all non-ASCII characters in the output are escaped with <code>\uXXXX</code> sequences, and the result is a str instance consisting of ASCII characters only. If <code>ensure_ascii</code> is false, some chunks written to fp may be unicode instances. This usually happens because the input contains unicode strings or the encoding parameter is used. Unless <code>fp.write()</code> explicitly understands unicode (as in <code>codecs.getwriter()</code>) this is likely to cause an error.</p>
<footer><strong>Python-doc</strong><cite><a href="https://docs.python.org/2/library/json.html#json.dump" target="_blank" rel="external">docs.python.org/2/library/json.html#json.dump</a></cite></footer></blockquote>
<p>So we can make the output contained unicode characters as follow:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> open(<span class="string">'data-u.json'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">    json.dump(data, f, ensure_ascii=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>Here’s the output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;ipa&quot;: &quot;ʃɔn&quot;, &quot;name&quot;: &quot;Sean&quot;&#125;</div></pre></td></tr></table></figure>
<p><code>json.load()</code> will automatically decode the string into unicode, so both of the  <code>{&quot;ipa&quot;: &quot;\u0283\u0254n&quot;, &quot;name&quot;: &quot;Sean”}</code> and <code>{&quot;ipa&quot;: &quot;ʃɔn&quot;, &quot;name&quot;: &quot;Sean”}</code> can be successfully parsed.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This post introduces some encoding-related  topics in python:</p>
<ol>
<li>We need to specify source encoding with a magic comment like <code># coding=utf-8</code> and make the encoding of the source file consistent with it, so that the python interpreter can understand the non-ascii characters in the source code.</li>
<li>To trans-code between two encodings, we need first decode the string to unicode and then encode it into another encoding.</li>
<li>Make sure the encoding of the string and terminal are same when you want to print it correctly in the terminal.</li>
<li>The strings must be in the same encoding or format, e.g. UTF-8 or unicode so that they can be manipulated together.</li>
<li>To make the JSON file readable, specify <code>ensure_ascii</code> as <code>False</code>.</li>
</ol>
<p><strong>More thoughts on it:</strong> I tried several ways to organize this post and removed some obscure parts of python unicode introduction, but still it’s kind of listing of knowledge points. Python2 receives lots of criticism because of the complicated string-unicode trans-coding. No doubt it is a defect, and in Python3 all the string literals are unicode. Also you can use <code>from __future__ import unicode_literals</code> to make the string literals be unicode in python2. However, some functions may only accept ordinary string instead of unicode, and still you need to care about the encoding. Understanding the encoding mechanism is important for learning python, especially dealing with multi-language and internationalization.</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.sean-lan.com/2017/11/29/python2-unicode/" data-id="cjajtse7w000hj5uore5khqgl" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a href="/2017/08/15/fetch-meets-302/" class="pre">What will happen when fetch meets a 302 status code?</a></div><div id="disqus_thread"><script>var disqus_shortname = 'uniquelanxiang';
var disqus_identifier = '2017/11/29/python2-unicode/';
var disqus_title = 'Practical Encoding in Python2';
var disqus_url = 'http://www.sean-lan.com/2017/11/29/python2-unicode/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//uniquelanxiang.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.sean-lan.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Backend/">Backend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Frontend/">Frontend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Language/">Language</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile-Application/">Mobile Application</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Koa/" style="font-size: 15px;">Koa</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/29/python2-unicode/">Practical Encoding in Python2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/fetch-meets-302/">What will happen when fetch meets a 302 status code?</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/react-animation/">CSS Animation and the Usage with React</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/11/server-side-rendering/">Server Side Rendering with Redux and React-Server</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/set-up-proxy-in-terminal/">Setting Up HTTP Proxy in Terminal</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/25/javascript-closure/">Javascript Closure: Typical Usages and Gotchas</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/python-re-grammar/">Python re Grammar Guide</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/python-re-quick-guide/">Quick Guide to Python re module</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/customize-browser-back-and-forward-button-behaviour/">Customize Browser Back and Forward Button Behavior</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/15/django-uwsgi-nginx/">Deploy Django Project in nginx with uWSGI on Mac OS X</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//uniquelanxiang.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.shinexu.com/" title="Vesion" target="_blank">Vesion</a><ul></ul><a href="http://buchi.la/" title="Matt" target="_blank">Matt</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Crusade.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7a1d7b5bb01512fff50895f7b6558c95";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>